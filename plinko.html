<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plinko 2D — Anti-atascos & Click ilimitado</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.65);
    --accent1-start:#7c3aed;
    --accent1-end:#06b6d4;
    --accent2-start:#f59e0b;
    --accent2-end:#ef4444;
    --success:#10b981;
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(800px 400px at 10% 10%, rgba(124,58,237,0.06), transparent 10%),
      radial-gradient(700px 350px at 90% 80%, rgba(6,182,212,0.04), transparent 10%),
      var(--bg);
    color:#e6eef8;
    -webkit-font-smoothing:antialiased;
    padding:28px;
  }
  .container{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#071025,#0b1220);display:grid;place-items:center;border:1px solid rgba(255,255,255,0.03)}
  h1{font-size:18px;margin:0}
  p.sub{margin:0;color:var(--muted);font-size:13px}

  main{display:grid;grid-template-columns:1fr 360px;gap:22px;align-items:start}
  @media (max-width:980px){ main{grid-template-columns:1fr} }

  /* Game card */
  .game-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;padding:18px;border:1px solid var(--glass-border);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }
  .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .select, .input { background:var(--glass);border:1px solid var(--glass-border);padding:10px 12px;border-radius:10px;color:inherit; }
  .btn{ padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1-start),var(--accent1-end)); color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(124,58,237,0.14); }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);box-shadow:none;color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,var(--accent2-start),var(--accent2-end));box-shadow:0 8px 30px rgba(245,158,11,0.12)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .stage{
    width:100%;
    background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);
    border-radius:14px;
    height:640px;
    position:relative;
    overflow:hidden;
  }
  #c{width:100%;height:100%}

  /* Right panel */
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;padding:18px;border:1px solid var(--glass-border);height:100%;
    position:sticky;top:28px;
  }
  .stat{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;background:var(--glass-2);border:1px solid rgba(255,255,255,0.02)}
  .stat strong{font-size:16px}
  .small{color:var(--muted);font-size:13px}
  .bins{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin-top:12px}
  .bin{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:8px 6px;border-radius:8px;text-align:center;font-size:12px;color:var(--muted)}
  .bin.highlight{background:linear-gradient(90deg,var(--accent1-start),var(--accent1-end));color:white;border:none}

  .history{margin-top:12px}
  .history-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;background:var(--glass-2);border:1px solid rgba(255,255,255,0.02);margin-bottom:6px;font-size:13px}
  .footer-note{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  /* modal */
  .modal{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.85));z-index:70;opacity:0;visibility:hidden;transition:opacity .18s, visibility .18s}
  .modal.open{opacity:1;visibility:visible}
  .modal-card{background:linear-gradient(180deg,#0b1220,#071026);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:540px;box-shadow:0 30px 80px rgba(2,6,23,0.7)}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3L21 9L16 21H8L3 9L12 3Z" stroke="url(#g1)" stroke-width="1.2" stroke-linejoin="round"/><defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#7c3aed"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
      </div>
      <div>
        <h1>Plinko 2D — Anti-atascos</h1>
        <p class="sub">Canvas 2D con rebotes realistas, sin atascos, y clics ilimitados (una bola por clic).</p>
      </div>
    </div>
    <div class="controls">
      <div style="background:var(--glass);padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border);display:flex;gap:8px;align-items:center">
        <div style="width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,#34d399,#10b981)"></div>
        <div style="font-weight:700">0.524 BTC</div>
        <div style="font-size:12px;color:var(--muted)">Balance</div>
      </div>
    </div>
  </header>

  <main>
    <section class="game-card" aria-labelledby="gameTitle">
      <div class="top-row">
        <div>
          <div style="display:flex;gap:8px;align-items:center">
            <h2 id="gameTitle" style="margin:0;font-size:16px">Plinko — 2D</h2>
            <div class="small" style="margin-left:6px">12–16 filas</div>
          </div>
          <div class="small" style="margin-top:6px">Soltá una bola por clic; podés cliquear varias veces seguido. Todas terminan en un multiplicador.</div>
        </div>

        <div class="controls">
          <select id="rowsSelect" class="select" title="Filas">
            <option value="12">12 filas</option>
            <option value="13">13 filas</option>
            <option value="14">14 filas</option>
            <option value="15">15 filas</option>
            <option value="16" selected>16 filas</option>
          </select>
          <select id="riskSelect" class="select" title="Riesgo">
            <option value="low">Riesgo bajo</option>
            <option value="medium" selected>Riesgo medio</option>
            <option value="high">Riesgo alto</option>
          </select>
          <input id="betInput" class="input" type="number" min="0.0001" step="0.0001" value="0.01" title="Apuesta (BTC)" />
          <button id="dropBtn" class="btn">Soltar (1)</button>
          <button id="autoBtn" class="btn ghost">Auto</button>
        </div>
      </div>

      <div id="stage" class="stage">
        <canvas id="c"></canvas>
      </div>
    </section>

    <aside>
      <div class="panel" aria-labelledby="panelTitle">
        <h3 id="panelTitle" style="margin:0 0 8px">Panel</h3>
        <div class="stat"><div class="small">Estado</div><strong id="stateLabel">Listo</strong></div>
        <div class="stat"><div class="small">Apuesta</div><strong id="betLabel">0.0100 BTC</strong></div>
        <div class="stat"><div class="small">Filas</div><strong id="rowsLabel">16</strong></div>
        <div class="stat"><div class="small">Riesgo</div><strong id="riskLabel">Medio</strong></div>
        <div class="stat"><div class="small">Resultado (última)</div><strong id="resultLabel">-</strong></div>
        <div class="stat"><div class="small">Pago (última)</div><strong id="payoutLabel">-</strong></div>

        <h4 style="margin:12px 0 6px">Multiplicadores</h4>
        <div id="binsWrap" class="bins"></div>

        <div class="history">
          <h4 style="margin:12px 0 6px">Historial</h4>
          <div id="history"></div>
        </div>
        <div class="footer-note">Físicas simplificadas. Anti-atascos: nudge, atracción a bin y límites seguros.</div>
      </div>
    </aside>
  </main>
</div>

<!-- modal -->
<div class="modal" id="modal">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center"><strong id="modalTitle">Resultado</strong><button onclick="closeModal()" class="btn ghost">Cerrar</button></div>
    <div id="modalBody" style="margin-top:12px;color:var(--muted)"></div>
  </div>
</div>









<script>
/* ==== WALLET (ARS) — saldo compartido entre todos los juegos ==== */
(function(){
  const STORAGE_KEY = 'casino_balance_ARS';
  const ADMIN_PATH = './admin.json';
  const DEFAULT_BAL = 1000; // si no hay admin.json ni storage
  const POLL_MS = 0; // 0 = sin polling automático; se puede habilitar si deseas

  function toNumber(v){
    if(v===null||v===undefined) return 0;
    v = String(v).replace(/[^\d\.,-]/g,'').trim();
    // normalizar separadores: quitar miles y dejar punto decimal
    v = v.replace(/\.(?=.*\.)/g,'').replace(/,(?=.*\,)/g,'');
    v = v.replace(',', '.');
    const n = parseFloat(v);
    return isNaN(n)?0:n;
  }
  function fmt(n){
    if (Math.abs(Math.round(n) - n) < 1e-9) return Math.round(n).toLocaleString('es-AR');
    return n.toLocaleString('es-AR', {minimumFractionDigits:2, maximumFractionDigits:2});
  }
  function setText(el, amountARS){
    if(!el) return;
    const txt = fmt(amountARS) + ' ARS';
    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = txt;
    else el.textContent = txt;
  }

  const Wallet = {
    get(){ const v = localStorage.getItem(STORAGE_KEY); return v===null? null : Number(v)||0; },
    set(v){ localStorage.setItem(STORAGE_KEY, String(Number(v)||0)); Wallet.updateDisplays(); },
    add(v){ const cur = Number(localStorage.getItem(STORAGE_KEY))||0; Wallet.set(cur + Number(v||0)); },
    sub(v){ const cur = Number(localStorage.getItem(STORAGE_KEY))||0; Wallet.set(cur - Number(v||0)); },
    ensure(){
      let v = Wallet.get();
      if(v!==null) return Promise.resolve(v);
      return fetch(ADMIN_PATH, {cache:'no-store'}).then(r=>r.ok?r.json():{balance_ARS:DEFAULT_BAL})
      .catch(()=>({balance_ARS:DEFAULT_BAL}))
      .then(cfg=>{ Wallet.set(Number((cfg && cfg.balance_ARS)!=null? cfg.balance_ARS : DEFAULT_BAL)); return Wallet.get(); });
    },
    updateDisplays(){
      const bal = Number(localStorage.getItem(STORAGE_KEY))||0;
      ['#balance','#saldo','#balanceLabel','.balance','.saldo','.user-balance','.balance-value'].forEach(sel=>{
        document.querySelectorAll(sel).forEach(el=> setText(el, bal));
      });
      // también limpiar BTC visibles en texto
      const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
      let n; while(n = walker.nextNode()){
        if(/\bBTC\b/i.test(n.nodeValue) || /([0-9\.,]+)\s*(BTC|btc)/.test(n.nodeValue)){
          n.nodeValue = n.nodeValue.replace(/([0-9\.,]+)\s*(BTC|btc)/ig, fmt(bal) + ' ARS').replace(/BTC/ig, 'ARS');
        }
      }
    }
  };
  window.WalletARS = Wallet;

  // Ajustes de inputs de apuesta
  function normalizeBetInputs(){
    document.querySelectorAll('input#betInput, input[name*=bet], input[id*=bet], input[class*=bet], input[name*=apuesta], input[id*=apuesta], input[class*=apuesta]').forEach(inp=>{
      try{
        inp.min = '1'; inp.step = '1';
        if(!inp.value || /BTC/i.test(inp.value)) inp.value = '100';
        inp.placeholder = 'Monto en ARS';
      }catch(e){}
    });
    document.querySelectorAll('#betLabel, .bet-label, .apuesta-label').forEach(l=>{ const bal=Wallet.get()||0; setText(l, bal); });
    // Sustituir textos BTC por ARS en elementos comunes
    document.querySelectorAll('*').forEach(el=>{
      if(el.children && el.children.length) return;
      if(typeof el.textContent === 'string' && /BTC/i.test(el.textContent)){
        el.textContent = el.textContent.replace(/BTC/ig, 'ARS');
      }
    });
  }

  // ==== Parches por juego ====

  // Blackjack: sincronizar GAME.balance con Wallet y usar ARS
  function patchBlackjack(){
    if(!window.GAME || !window.updateBalance) return;
    // formateador ARS
    window.formatBTC = function(x){ 
      const n = Number(x)||0;
      return (Math.abs(Math.round(n)-n)<1e-9? Math.round(n).toLocaleString('es-AR') : n.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}));
    };
    // envolver updateBalance para que escriba también a Wallet
    const _updateBalance = window.updateBalance;
    window.updateBalance = function(){
      try{ Wallet.set(Number(GAME.balance)||0); }catch(e){}
      if(typeof _updateBalance === 'function') _updateBalance();
      const el = document.getElementById('betLabel') || document.querySelector('.balance,.saldo,#balanceLabel');
      if(el && /BTC/i.test(el.textContent)) el.textContent = el.textContent.replace(/BTC/ig,'ARS');
    };
    Wallet.ensure().then(bal=>{
      try{ GAME.balance = Number(bal)||0; }catch(e){}
      if(typeof window.updateBalance === 'function') window.updateBalance();
    });
    try{
      let _bal = window.GAME.balance;
      Object.defineProperty(window.GAME, 'balance', {
        get(){ return _bal; },
        set(v){ _bal = Number(v)||0; Wallet.set(_bal); },
        configurable: true
      });
    }catch(e){}
    normalizeBetInputs();
    setInterval(()=>Wallet.updateDisplays(), 800);
  }

  // Mines: restar apuesta al iniciar, sumar payout en win/cashout
  function patchMines(){
    if(typeof window.startGame !== 'function' || typeof window.endGame !== 'function') return;
    const _startGame = window.startGame;
    window.startGame = function(){
      const betInput = document.getElementById('betInput') || document.querySelector('input[id*=bet],input[name*=bet],input[class*=bet]');
      const bet = Wallet.get()!=null ? toNumber(betInput ? betInput.value : '0') : 0;
      const bal = Wallet.get() ?? DEFAULT_BAL;
      if(!bet || bet<=0){ alert('Ingresa una apuesta válida (ARS).'); return; }
      if(bet > bal){ alert('Saldo insuficiente.'); return; }
      Wallet.sub(bet);
      return _startGame.apply(this, arguments);
    };
    const _endGame = window.endGame;
    window.endGame = function(result){
      const betInput = document.getElementById('betInput') || document.querySelector('input[id*=bet],input[name*=bet],input[class*=bet]');
      const bet = toNumber(betInput ? betInput.value : '0');
      if(result === 'win' && typeof window.calcMultiplier === 'function'){
        const rev = (window.revealed && window.revealed.size) ? window.revealed.size : 0;
        const mines = (window.mineCount!=null) ? window.mineCount : 3;
        const mult = window.calcMultiplier(rev, mines);
        const payout = bet * mult;
        Wallet.add(payout);
      }
      return _endGame.apply(this, arguments);
    };
    if(typeof window.cashout === 'function'){
      const _cash = window.cashout;
      window.cashout = function(){
        let bet = 0, payout = 0;
        const betInput = document.getElementById('betInput') || document.querySelector('input[id*=bet],input[name*=bet],input[class*=bet]');
        bet = toNumber(betInput ? betInput.value : '0');
        if(typeof window.calcMultiplier === 'function' && window.revealed && window.mineCount!=null){
          const mult = window.calcMultiplier(window.revealed.size, window.mineCount);
          payout = bet * mult;
        }
        const ret = _cash.apply(this, arguments);
        if(payout>0) Wallet.add(payout);
        return ret;
      }
    }
    normalizeBetInputs();
  }

  // Plinko: restar por bola, pagar onBallSettled
  function patchPlinko(){
    if(typeof window.spawnBall !== 'function' || typeof window.onBallSettled !== 'function') return;
    const _spawnBall = window.spawnBall;
    window.spawnBall = function(){
      const betInput = document.getElementById('betInput') || document.querySelector('input[id*=bet],input[name*=bet],input[class*=bet]');
      const bet = toNumber(betInput ? betInput.value : '0');
      const bal = Wallet.get() ?? DEFAULT_BAL;
      if(!bet || bet<=0){ alert('Ingresa una apuesta válida (ARS).'); return; }
      if(bet > bal){ alert('Saldo insuficiente.'); return; }
      Wallet.sub(bet);
      return _spawnBall.apply(this, arguments);
    };
    const _onBallSettled = window.onBallSettled;
    window.onBallSettled = function(b){
      try{
        const rowsSelect = document.getElementById('rowsSelect') || document.querySelector('#rows,#rowsSelect,select[id*=rows]');
        const riskSelect = document.getElementById('riskSelect') || document.querySelector('#risk,#riskSelect,select[id*=risk]');
        const betInput = document.getElementById('betInput') || document.querySelector('input[id*=bet],input[name*=bet],input[class*=bet]');
        const bet = toNumber(betInput ? betInput.value : '0');
        const mult = window.MULTS[riskSelect.value][parseInt(rowsSelect.value,10)][b.idx];
        const payout = bet * mult;
        Wallet.add(payout);
      }catch(e){}
      return _onBallSettled.apply(this, arguments);
    };
    normalizeBetInputs();
  }

  // Aviator: restar al iniciar, sumar en cashout
  function patchAviator(){
    if(typeof window.startRound !== 'function' || typeof window.cashout !== 'function') return;
    const _start = window.startRound;
    window.startRound = function(){
      const betInput = document.getElementById('betInput') || document.querySelector('input[id*=bet],input[name*=bet],input[class*=bet]');
      const bet = toNumber(betInput ? betInput.value : '0');
      const bal = Wallet.get() ?? DEFAULT_BAL;
      if(!bet || bet<=0){ alert('Ingresa una apuesta válida (ARS).'); return; }
      if(bet > bal){ alert('Saldo insuficiente.'); return; }
      Wallet.sub(bet);
      return _start.apply(this, arguments);
    };
    const _cash = window.cashout;
    window.cashout = function(){
      try{
        const payout = (typeof window.bet!=='undefined' && typeof window.currentMult!=='undefined') ? (Number(window.bet)||0) * (Number(window.currentMult)||0) : 0;
        if(payout>0) Wallet.add(payout);
      }catch(e){}
      return _cash.apply(this, arguments);
    };
    normalizeBetInputs();
  }

  function patchIndex(){ Wallet.updateDisplays(); }

  // Run
  Wallet.ensure().then(()=>{
    normalizeBetInputs();
    patchBlackjack();
    patchMines();
    patchPlinko();
    patchAviator();
    patchIndex();
    Wallet.updateDisplays();
  });
})();
</script>
</body>
</html>
